\chapter{Алгоритм многогипотезного восстановления траектории}
\renewcommand{\headtext}{\thechapter.~Алгоритм многогипотезного восстановления траектории}


\section{??? Название ???}

\section{Математическая модель ???}

??? слова про плоскость / плоскую Землю ???

Математическая модель движения воздушного судна использует
следующее модельное описание динамики самолёта:
\begin{eqnarray}
\dot x		 & = & v \cos{\varphi}, \nonumber \\
\dot z		 & = & v \sin{\varphi}, \nonumber \\
\dot \varphi & = & u / v,         \label{MainSyst4D} \\
\dot v		 & = & w.	\nonumber
\end{eqnarray}

\vspace{-2mm} \noindent
Здесь 
$x$, $z$~--- координаты положения на плоскости;
$\varphi$~--- угол наклона вектора скорости, 
отсчитываемый по часовой стрелке от вертикальной оси~$x$;
$v$~--- величина скорости;
$u$~--- боковое ускорение;
$w$~--- продольное ускорение.

Предполагаем, что управления $u,w$ стеснены геометрическими ограничениями
$|u| \le u_{\mathrm{max}}$,  $w \le w_{\mathrm{max}}$.

...



\section{Структура данных программы, термины}

{\em Участок постоянного управления}~--- промежуток времени, характеризующийся
постоянством ускорений ВС.
Фиксируются: $u_i$ (поле записи {\tt .Upr})~--- значение поперечного управления;
$w_i$ (поле {\tt .Wpr})~--- значение продольного управления;
$t_{n i}$ ({\tt .UTn})~--- время начала участка постоянного управления;
$t_{k i}$ ({\tt .UTk})~--- время конца участка постоянного управления.


{\em Трек управления} --- двунаправленный список участков постоянного управления.
Каждый участок постоянного управления в треке управления должен содержать
ссылки на предыдущий участок (поле записи {\tt .Prd}) 
и последующий участок (поле {\tt .Sld}).
Поля $t_{n i}$ и $t_{k i}$ последовательных элементов списка
должны быть согласованы, т.е. $t_{k i-1}= t_{n i}$.
Также участки постоянного управления могут содержать поля {\tt .nTr} и 
{\tt .kTr}~---
ссылки на участок геометрического трека (определяется ниже),
порождённый рассматриваемым треком управления.

{\em Замер РЛС} содержит поля:
{\tt .Xzr}~--- координата замера <<на cевер>> в плоскости Земли;
{\tt .Zzr}~--- координата замера <<на восток>> в плоскости Земли;
{\tt .Hzr}~--- высота замера над плоскостью Земли;
{\tt .Tzr}~--- время замера;
{\tt .Nrls}~--- номер РЛС замера.


{\em Трек замеров} --- двунаправленный список замеров РЛС.
Каждый замер РЛС в~треке замеров должен содержать
ссылки на предыдущий замер (поле записи {\tt .Prd}) 
и последующий замер (поле {\tt .Sld}).


{\em Точка геометрического трека} описывает положение ВС и содержит поля:
{\tt .X}~--- координата ВС <<на cевер>> в плоскости Земли;
{\tt .Z}~--- координата ВС <<на восток>> в плоскости Земли;
{\tt .H}~--- высота ВС над плоскостью Земли;
{\tt .Phi}~--- направление скорости ВС (азимут по часовой стрелке относительно направленияна север);
{\tt .V}~--- величина скорости ВС.

?? Где-то тут нужны слова про равномерную сетку времени...

{\em Геометрический трек} --- двунаправленный список точек геометрического трека.
Каждая точка геометрического трека должена содержать
ссылки на предыдущий замер (поле записи {\tt .Prd}) 
и последующий замер (поле {\tt .Sld}).
Вычисление геометрического трека по треку управления возможно при помощи
процедуры  {\tt PostrTrekaSTekUchUprPrymo()}. 
Аргументом этой процедуры является первый элемент списка трека управления,
этот элемент должен иметь поле {\tt .nTr}, указывающее на точку
геометрического трека.
Значения полей этой точки используются как начальная точка при интегрировании
уравнений движения ВС.


\section{Вычисление веса траектории ???}



\section{Алгоритм оптимизации}

Алгоритм оптимизации основывается на методе Хука~-- Дживса [??].

В качестве входной информации алгоритм получает ссылку на трек управления
(последовательность участков постоянного управления).
% геометрический трек

Алгоритм варьирует:
значения продольного управления $w_i$,
значения поперечного управления $u_i$,
время переключения между участками постоянного управления $t_{n i}$.
При этом учитываются ограничения:
на абсолютные значения управления, 
на минимальную продолжительность постоянного управления.
Целью варьирования является построение последовательности
управлений, которые бы определяли геометрический трек 
с минимальным весом.

Для вычисления веса трека алгоритм формирует временный трек управления.
В~процессе формирования временного трека происходит проверка нарушения
ограничений на управление, если ограничения нарушаются, то происходит
возврат в основной алгоритм Хука~-- Дживса, при этом в качестве
значения минимизируемой функции возвращается штраф пропорциональный величине
нарушения ограничения (при этом при подаче на вход алгоритма
оптимизации трека управления с нарушением ограничений возможно <<скатывание>>
алгоритма в область, где ограничения не нарушаются).
Для построения геометрического трека по сформированному треку управления используется
обращение к процедуре {\tt PostrTrekaSTekUchUprPrymo()}
(которая производит интегрирование),
затем вес трека вычисляется обращением к функции
{\tt RaschetVesaTreka()} и происходит возврат в основной алгоритм
алгоритм Хука~-- Дживса с возвратом веса трека в качестве значения минимизируемой функции.


Варьирование прекращается когда текущие шаги варьирования
оказываются меньше заданных финальных шагов варьирования.

Алгоритм возвращает ссылку на новый трек управления, получившийся
в результате варьирования.
В свою очередь трек управления содержит ссылки на соответствующий геометрический трек.



\subsubsection{Константы-параметры алгоритма оптимизации}

Алгоритм использует следующие постоянные  параметры (константы):\\
{\tt Du1 = 0.5} -- начальный шаг варьирования поперечного управления;\\
{\tt Dw1 = 0.25} -- начальный шаг варьирования продольного управления;\\
{\tt Dt1 = 32.0} -- начальный шаг варьирования разбивки времени;\\
{\tt DuFin = 0.01} -- финальный шаг варьирования поперечного управления;\\
{\tt DwFin = 0.01} -- финальный шаг варьирования продольного управления;\\
{\tt DtFin = 0.02} -- финальный шаг варьирования разбивки времени;\\
{\tt MAXu = 4} ($u_{\mathrm{max}}$) -- максимальное значение поперечного управления;\\
{\tt MAXw = 2} ($w_{\mathrm{max}}$) -- максимальное значение продольного управления;\\
{\tt dtmin = 10.0} -- минимальный промежуток времени постоянного управления;\\
{\tt dh = 0.5} -- множитель уменьшения шага при неудаче в <<поиске вокруг базовой точки>> метода Хука~-- Дживса.





\section{Программа конвертации данных}

Программа {\tt tracks\_plots\_00} предназначена для фильтрации и конвертации данных 
(РЛС, АЗН-В, монорадарная обработка, мультирадарная обработка)
из текстовых файлов {\tt tracks.txt}, {\tt plots.txt}, {\tt plots\_ads.txt}, получаемых
при помощи программы {\tt vidparser.exe} из файлов {\tt .vid}.
Цель конвертации --- получить небольшие по объёму текстовые файлы данных
для использования в программе многогипотезного восстановления траектории.

В связи с тем, что исходные файлы имеют очень большой объём (гигабайты), полная загрузка информации
из файлов в оперативную память (при использовании 32-битной ОС и 32-битного компилятора)
не представляется возможной.
Используются неоднократное чтение файлов и приближённая оценка сверху количества замеров
в РЛС-треках.

%Алгоритм:
\subsubsection{Алгоритм}
\vspace{-3mm}
\begin{itemize}
\item Первое чтение файла {\tt tracks.txt}, сбор общей статистики по источникам, 
глобальным идентификаторам трека и т.п.
\item Выделение памяти для АЗН-треков.
\item Чтение файла {\tt plots\_ads.txt}. Заполнение массивов замеров АЗН.
\item Упорядочение замеров внутри АЗН-треков по времени, запись треков в файлы {\tt ads.new4} и {\tt ads.plt}.
\item Освобождение памяти для АЗН-треков.
\item Выделение памяти (на основе приближённой оценки) для  монорадарных треков (моно-треков),
треков мультирадарной обработки (мульти-треков), РЛС-треков.
\item Второе чтение файла {\tt tracks.txt}.
Заполнение массивов моно-треков и мульти-треков, 
заполнение номеров замеров в РЛС-треках.
\item Упорядочение замеров внутри моно-треков и мульти-треков по времени,
запись треков в файлы {\tt *\_mr.new4} и {\tt *\_mr.plt}.
\item Чтение файла {\tt plots.txt}. Заполнение массивов замеров РЛС-треков.
\item Упорядочение замеров внутри РЛС-треков по времени,
запись треков в файлы {\tt *\_r.new4} и {\tt *\_r.plt}.
\end{itemize}

\subsubsection{Особенности текущей версии, параметры программы}

Воздушные суда идентифицируются по параметру {\tt global} (глобальный номер трека),
при этом в обработку идёт не более {\tt AZN\_TRACKS\_MAX} воздушных судов, АЗН-треки которых
имеют не менее {\tt AZN\_TRACKS\_MIN\_MEASUR} замеров (при этом из подходящих
выбираются АЗН-треки с наибольшим числом замеров).

Из файлов {\tt tracks.txt}, {\tt plots.txt} учитываются РЛС-замеры и моно-замеры,
параметр {\tt sensor} которых равен параметру {\tt RADAR\_SENSOR\_ONLY}.

Если после всех фильтраций трек содержит меньше {\tt TRACKS\_MIN\_MEASUR} замеров,
то он не записывается.

Выходные файлы записываются в поддиректорию {\tt new}, которая не должна существовать 
до запуска программы.
В директории {\tt new} создаются поддиректории, совпадающие с параметром {\tt global}
записываемых ВС. 
Записываются файлы {\tt ads.new4} и {\tt ads.plt} (АЗН-треки), 
{\tt 240\_mr.new4} и {\tt 240\_mr.plt} (мульти-треки),
{\tt *\_mr.new4} и {\tt *\_mr.plt} (моно-треки),
{\tt *\_r.new4} и {\tt *\_r.plt} (РЛС-треки).
Здесь {\tt *} --- номер РЛС.

Файлы {\tt *.plt} имеют формат треков программы Ozi Explorer и используются
для визуализации треков при помощи программы GPSMapEdit.

\subsubsection{Формат файлов {\tt .new4}}

Текстовые файлы, в которых построчно записаны замеры.
Столбцы: время замера, широта замера, долгота замера, высота замера.
Столбцы разделяются символом табуляции.

Для РЛС-треков в качестве координат замеров используются поля {\tt lat} и {\tt lon}
файла {\tt plots.txt}, т.е. широта и долгота, 
сформированные из дальности и азимута сырых РЛС-замеров, 
которые предварительно корректируются с учётом текущей оценки систематических ошибок
в программе мультирадарной обработки.
